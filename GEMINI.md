# 開発ガイドライン

本ドキュメントは、このコードベースで作業する上で重要な情報を含みます。これらのガイドラインを厳守してください。

## 開発の基本ルール

1. パッケージ管理
   - uv のみを使用し、pip は絶対に使用しないこと
   - インストール: `uv add package`
   - ツール実行: `uv run tool`
   - アップグレード: `uv add --dev package --upgrade-package package`
   - 禁止事項: `uv pip install`、`@latest` 構文

2. コード品質
   - すべてのコードに型ヒントを付与すること
   - 公開 API には必ずドックストリングを記述すること
   - 関数は関心を絞り、小さく保つこと
   - 既存のパターンに厳密に従うこと
   - 1 行の長さ: 最大 120 文字
   - テスト要件を満たすテストコードを作成すること
   - ruffとpyrightのPythonツールを使用すること

3. テスト要件
   - フレームワーク: `uv run --frozen pytest`
   - カバレッジ: エッジケースとエラーをテストすること
   - 新機能にはテストが必須
   - バグ修正には回帰テストが必須

- ユーザー報告に基づくバグ修正や機能追加のコミットには、以下を追加すること:

  ```bash
  git commit --trailer "Reported-by:<name>"
  ```

  ここで `<name>` はユーザーの名前。

- GitHub の Issue に関連するコミットには、以下を追加すること:

  ```bash
  git commit --trailer "Github-Issue:#<number>"
  ```

- 「co-authored-by」等を絶対に記載しないこと。特に、コミットメッセージや PR の作成に使用したツールには決して言及しないこと。

## プルリクエスト

- 変更内容の詳細な説明を書いてください。解決しようとしている問題の高レベルな説明と、その解決方法に焦点を当てます。コードの詳細には、明確さが増す場合のみ踏み込みます。
- 「co-authored-by」等を絶対に記載しないこと。特に、コミットメッセージや PR の作成に使用したツールには決して言及しないこと。

## Python ツール

## コード整形

1. Ruff
   - フォーマット: `uv run --frozen ruff format .`
   - チェック: `uv run --frozen ruff check .`
   - 自動修正: `uv run --frozen ruff check . --fix`
   - 重要事項:
     - 行の長さ（88 文字）
     - インポート順序（I001）
     - 未使用のインポート
   - 折り返し規則:
     - 文字列: 丸括弧を使う
     - 関数呼び出し: 複数行にし、適切にインデント
     - インポート: 複数行に分割

2. 型チェック
   - ツール: `uv run --frozen pyright`
   - 要件:
     - Optional には明示的な None チェックを行う
     - 文字列に対して型の絞り込みを行う
     - チェックが通るなら、バージョン警告は無視してよい


## エラー解決

1. CI の失敗
   - 修正の優先順位:
     1. フォーマット
     2. 型エラー
     3. Lint
   - 型エラーへの対処:
     - 該当する行全体の文脈を確認する
     - Optional 型を確認する
     - 型の絞り込みを追加する
     - 関数シグネチャを検証する

2. よくある問題
   - 行の長さ:
     - 文字列は丸括弧で分割する
     - 関数呼び出しは複数行にする
     - インポートを分割する
   - 型:
     - None チェックを追加する
     - 文字列型を絞り込む
     - 既存のパターンに合わせる

3. ベストプラクティス
   - コミット前に `git status` を確認する
   - 型チェックの前にフォーマッターを実行する
   - 変更は最小限に保つ
   - 既存のパターンに従う
   - 公開 API を文書化する
   - 十分にテストする

## 例外処理

- 例外を捕捉する場合は、`logger.error()` ではなく必ず `logger.exception()` を使用すること
  - メッセージに例外を含めないこと: `logger.exception("Failed")` とし、`logger.exception(f"Failed: {e}")` とはしない
- 可能な限り特定の例外のみを捕捉すること:
  - ファイル操作: `except (OSError, PermissionError):`
  - JSON: `except json.JSONDecodeError:`
  - ネットワーク: `except (ConnectionError, TimeoutError):`
- `Exception` を捕捉してよいのは以下の場合のみ:
  - 絶対にクラッシュさせてはならないトップレベルのハンドラ
  - クリーンアップ処理ブロック（ログは debug レベル）